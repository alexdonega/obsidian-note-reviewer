---
wave: 3
depends_on: [02-01]
files_modified:
  - packages/annotation/src/types/DocumentVersion.ts
  - packages/annotation/src/store/useVersionStore.ts
  - packages/annotation/src/components/VersionHistory.tsx
  - packages/annotation/src/components/DiffViewer.tsx
  - packages/annotation/src/utils/diffGenerator.ts
  - packages/annotation/src/api/versionApi.ts
autonomous: true
must_haves:
  - Document versions are saved on significant changes
  - User can view version history timeline
  - User can compare two versions with diff viewer
  - User can restore previous version
  - Version retention policy limits stored versions (default: 50)
---

# Plan 02-04: Create Version History with Diff Viewing

## Objective
Implement document version history with diff visualization and restore capability.

## Context
Based on research recommendations:
- Store full document snapshots in Supabase (document_versions table)
- Use react-diff-viewer-continued for diff visualization
- Create version on explicit save or significant changes (not on every keystroke)
- Implement retention policy (keep last 50 versions per document)
- Side-by-side diff view for comparison

## Tasks

### Task 1: Create DocumentVersion type
```xml
<task>
  <file>packages/annotation/src/types/DocumentVersion.ts</file>
  <description>Define types for document versioning</description>
  <steps>
    1. Create DocumentVersion interface: id, documentId, content, createdAt, createdBy, changeDescription, annotationIds
    2. Create VersionDiff interface: oldVersionId, newVersionId, changes[]
    3. Create VersionChange type: type (add/remove/equal), lineNumber, content
    4. Export types for use in components and API
  </steps>
</task>
```

### Task 2: Create useVersionStore
```xml
<task>
  <file>packages/annotation/src/store/useVersionStore.ts</file>
  <description>Build Zustand store for version management</description>
  <steps>
    1. Define VersionStore interface with versions[] and actions
    2. Implement createVersion(action) - saves document snapshot
    3. Implement getVersionsForDocument(documentId) - retrieves all versions
    4. Implement restoreVersion(versionId) - restores document content
    5. Implement compareVersions(versionId1, versionId2) - returns diff
    6. Add devtools and persist middleware
    7. Integrate with Supabase for persistence (table: document_versions)
  </steps>
</task>
```

### Task 3: Create version API utilities
```xml
<task>
  <file>packages/annotation/src/api/versionApi.ts</file>
  <description>Create API functions for version CRUD operations</description>
  <steps>
    1. Create createVersion(documentId, content, userId, description) API function
    2. Create getVersions(documentId) - paginated fetch with limit
    3. Create getVersion(versionId) - fetch single version
    4. Create deleteVersion(versionId) - soft delete with flag
    5. Create restoreVersion(versionId) - restores content to document
    6. Implement retention policy: auto-delete old versions beyond 50
  </steps>
</task>
```

### Task 4: Create DiffViewer component
```xml
<task>
  <file>packages/annotation/src/components/DiffViewer.tsx</file>
  <description>Build side-by-side diff viewer using react-diff-viewer-continued</description>
  <steps>
    1. Install: `bun add react-diff-viewer-continued`
    2. Create component accepting oldContent, newContent props
    3. Configure ReactDiffViewer with:
       - splitView={true} for side-by-side comparison
       - useDarkTheme={true} for dark mode
       - hideLineNumbers={false}
       - showDiffOnly={false}
    4. Add size check: warn for documents >10,000 lines
    5. Add loading state during diff generation
     </steps>
</task>
```

### Task 5: Create VersionHistory component
```xml
<task>
  <file>packages/annotation/src/components/VersionHistory.tsx</file>
  <description>Build timeline component for version history</description>
  <steps>
    1. Create component that fetches versions for current document
    2. Display timeline with version cards (date, author, description)
    3. Add "Compare" button for each version (opens comparison modal)
    4. Add "Restore" button for non-current versions
    5. Show annotation count snapshot for each version
    6. Handle empty state (no versions yet)
    7. Implement pagination if >20 versions
  </steps>
</task>
```

### Task 6: Create diff generator utilities
```xml
<task>
  <file>packages/annotation/src/utils/diffGenerator.ts</file>
  <description>Create utilities for generating document diffs</description>
  <steps>
    1. Install: `bun add diff` (for line-by-line diff)
    2. Create generateDiff(oldContent, newContent) function
    3. Returns array of changes with type (add/remove/equal), count, value
    4. Handle whitespace normalization
    5. Handle line ending conversions
    6. Export for use in DiffViewer and API
  </steps>
</task>
```

## Verification
- [ ] Document versions are saved on significant changes
- [ ] User can view version history timeline
- [ ] User can compare two versions with diff viewer
- [ ] User can restore previous version
- [ ] Version retention policy limits stored versions
