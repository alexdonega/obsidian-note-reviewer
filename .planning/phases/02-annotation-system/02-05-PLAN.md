---
wave: 3
depends_on: [02-01]
files_modified:
  - packages/annotation/src/components/MarkdownRenderer.tsx
  - packages/annotation/src/utils/markdownSanitizer.ts
  - packages/annotation/src/components/CodeBlock.tsx
  - packages/annotation/src/types/MarkdownConfig.ts
  - packages/annotation/src/utils/markdownTestCases.ts
autonomous: true
must_haves:
  - Markdown renders correctly with standard syntax (headings, lists, emphasis, links)
  - Code blocks display with syntax highlighting
  - Images render correctly with alt text
  - HTML is sanitized to prevent XSS
  - All markdown test cases pass
---

# Plan 02-05: Verify Markdown Rendering Supports Standard Syntax

## Objective
Verify and ensure markdown rendering supports standard syntax, code blocks with highlighting, and images with security.

## Context
Based on research recommendations:
- react-markdown is secure by default (uses rehype-sanitize)
- react-syntax-highlighter for code block highlighting
- DOMPurify for custom HTML rendering if needed
- Custom markdown parser already exists in packages/ui/utils/parser.ts
- Must verify XSS prevention via react-markdown configuration

## Tasks

### Task 1: Create MarkdownRenderer component
```xml
<task>
  <file>packages/annotation/src/components/MarkdownRenderer.tsx</file>
  <description>Build markdown renderer with syntax highlighting</description>
  <steps>
    1. Install: `bun add react-markdown react-syntax-highlighter`
    2. Create component accepting content prop
    3. Use ReactMarkdown as base renderer
    4. Configure code component with SyntaxHighlighter:
       - Use vscDarkPlus style
       - Support language detection from className
       - Handle inline code vs code blocks
    5. Configure image rendering with alt text support
    6. Enable rehype-sanitize for security
    7. Add custom components for links (open in new tab)
  </steps>
</task>
```

### Task 2: Create markdown sanitizer utilities
```xml
<task>
  <file>packages/annotation/src/utils/markdownSanitizer.ts</file>
  <description>Create sanitization utilities for markdown security</description>
  <steps>
    1. Import DOMPurify (already in dependencies)
    2. Create sanitizeHTML(html) function for custom HTML rendering
    3. Configure DOMPurify with safe defaults
    4. Create validateMarkdownContent(content) - checks for malicious patterns
    5. Add whitelist for safe HTML tags and attributes
    6. Export for use in MarkdownRenderer
  </steps>
</task>
```

### Task 3: Create CodeBlock component
```xml
<task>
  <file>packages/annotation/src/components/CodeBlock.tsx</file>
  <description>Build enhanced code block component</description>
  <steps>
    1. Create component for rendering code blocks
    2. Support copy-to-clipboard functionality
    3. Display language label in header
    4. Add line numbers (optional, toggleable)
    5. Integrate with SyntaxHighlighter from react-markdown
    6. Add loading state for async syntax highlighting
  </steps>
</task>
```

### Task 4: Create MarkdownConfig type
```xml
<task>
  <file>packages/annotation/src/types/MarkdownConfig.ts</file>
  <description>Create configuration types for markdown rendering</description>
  <steps>
    1. Create MarkdownConfig interface with options:
       - enableSyntaxHighlighting (default: true)
       - enableImageOptimization (default: true)
       - customRenderers object for overriding defaults
       - security settings (sanitization level)
    2. Export default config with recommended settings
    3. Create validateConfig(config) function
    4. Add TypeScript types for plugin components
  </steps>
</task>
```

### Task 5: Create markdown test cases
```xml
<task>
  <file>packages/annotation/src/utils/markdownTestCases.ts</file>
  <description>Create test cases to verify markdown rendering</description>
  <steps>
    1. Create test suite with sample markdown covering:
       - Headings (# ## ###)
       - Lists (ordered and unordered)
       - Emphasis (bold, italic, strikethrough)
       - Links ([text](url))
       - Images (![alt](url))
       - Code blocks (```language and inline `code`)
       - Blockquotes
       - Tables
    2. Create test assertions for each element type
    3. Add XSS test cases (script tags, javascript:, etc.)
    4. Export test functions for use with test runner
    5. Document expected rendering behavior
  </steps>
</task>
```

## Verification
- [ ] Markdown renders correctly with standard syntax
- [ ] Code blocks display with syntax highlighting
- [ ] Images render correctly with alt text
- [ ] HTML is sanitized to prevent XSS
- [ ] All markdown test cases pass
