---
wave: 1
depends_on: []
files_modified:
  - packages/annotation/src/types/Annotation.ts
  - packages/annotation/src/components/AnnotationMarker.tsx
  - packages/annotation/src/components/AnnotationOverlay.tsx
  - packages/annotation/src/hooks/useAnnotationTargeting.ts
  - packages/annotation/src/utils/elementSelector.ts
autonomous: true
must_haves:
  - Visual markers render correctly on markdown elements
  - User can select text and create annotations
  - Annotations persist across page refresh
  - Element targeting works across different markdown block types
---

# Plan 02-01: Enhance Annotation System with Visual Markers

## Objective
Enhance the existing annotation system to provide clear visual markers for annotations and improve element targeting capabilities.

## Context
The codebase already has:
- `AnnotationType` enum (DELETION, INSERTION, REPLACEMENT, COMMENT, GLOBAL_COMMENT)
- `useAnnotationStore` Zustand store for state management
- `AnnotationPanel` component for listing annotations
- `annotationTypeConfig` for styling different annotation types

What's missing:
- Visual markers rendered directly on annotated elements
- Precise element targeting for different markdown block types
- Consistent visual feedback across annotation states

## Tasks

### Task 1: Extend Annotation interface with metadata
```xml
<task>
  <file>packages/annotation/src/types/Annotation.ts</file>
  <description>Add visual metadata fields to Annotation interface</description>
  <steps>
    1. Add field: `markerColor?: string` - computed from annotation type
    2. Add field: `markerPosition?: { top: number; left: number }` - for marker placement
    3. Add field: `isHighlighted?: boolean` - for hover/focus state
    4. Add field: `targetSelector?: string` - CSS selector for element targeting
  </steps>
</task>
```

### Task 2: Create AnnotationMarker component
```xml
<task>
  <file>packages/annotation/src/components/AnnotationMarker.tsx</file>
  <description>Build visual marker component for annotations</description>
  <steps>
    1. Create component that accepts annotation and position props
    2. Use annotationTypeConfig to determine color/icon
    3. Implement click handler to select annotation
    4. Add hover state with increased opacity/size
    5. Support different marker styles per AnnotationType (underline, highlight, icon)
  </steps>
</task>
```

### Task 3: Implement element targeting utilities
```xml
<task>
  <file>packages/annotation/src/utils/elementSelector.ts</file>
  <description>Create utilities for targeting markdown elements</description>
  <steps>
    1. Create `findElementByOffset(offset: number)` - locate element by character offset
    2. Create `getSelectorForElement(element: HTMLElement)` - generate unique CSS selector
    3. Create `highlightElement(selector: string, type: AnnotationType)` - apply visual highlight
    4. Create `clearHighlight(selector: string)` - remove visual highlight
  </steps>
</task>
```

### Task 4: Build AnnotationOverlay component
```xml
<task>
  <file>packages/annotation/src/components/AnnotationOverlay.tsx</file>
  <description>Create overlay layer for rendering annotation markers</description>
  <steps>
    1. Create component that renders over markdown content
    2. Position markers using markerPosition from annotations
    3. Handle marker click events to select annotation
    4. Support both block-level and inline annotations
    5. Add z-index management to ensure markers appear above content
  </steps>
</task>
```

### Task 5: Create useAnnotationTargeting hook
```xml
<task>
  <file>packages/annotation/src/hooks/useAnnotationTargeting.ts</file>
  <description>Implement hook for annotation targeting logic</description>
  <steps>
    1. Create hook that listens for text selection events
    2. Calculate target element and offset for selection
    3. Provide callback for creating annotation from selection
    4. Handle edge cases (selection across blocks, partial element selection)
    5. Integrate with useAnnotationStore for persistence
  </steps>
</task>
```

## Verification
- [ ] Visual markers appear on annotated elements
- [ ] Clicking marker selects annotation in panel
- [ ] Different annotation types have distinct visual styles
- [ ] Markers persist after page refresh
- [ ] Element targeting works for paragraphs, headings, code blocks, lists
