---
wave: 2
depends_on: [02-01]
files_modified:
  - packages/annotation/src/types/Comment.ts
  - packages/annotation/src/store/useCommentStore.ts
  - packages/annotation/src/components/CommentThread.tsx
  - packages/annotation/src/components/CommentInput.tsx
  - packages/annotation/src/utils/threadHelpers.ts
  - packages/annotation/src/components/MentionsInput.tsx
autonomous: false
must_haves:
  - Comments display in threaded format with visual hierarchy
  - @mentions autocomplete shows user list with avatars
  - Replies nest under parent comments with indentation
  - Mentioned users are notified (stored in comment.mentions array)
  - Comment input supports @trigger for mentions
---

# Plan 02-02: Build Threaded Comment System

## Objective
Implement a threaded comment system with @mentions functionality for annotation discussions.

## Context
Based on research recommendations:
- Use react-mentions library for @mention autocomplete
- Extend Annotation interface with threadId field
- Create CommentThread and Comment interfaces
- Recursive rendering for nested replies
- Store mention IDs separately for notification system (Phase 5)

## Tasks

### Task 1: Define comment and thread types
```xml
<task>
  <file>packages/annotation/src/types/Comment.ts</file>
  <description>Create Comment, CommentThread, and AnnotationStatus types</description>
  <steps>
    1. Create Comment interface with: id, threadId, authorId, authorName, content, mentions[], createdAt, parentId
    2. Create CommentThread interface with: id, annotationId, comments[], status, createdAt, createdBy
    3. Create AnnotationStatus enum: OPEN, IN_PROGRESS, RESOLVED
    4. Export types for use in components and stores
  </steps>
</task>
```

### Task 2: Create useCommentStore
```xml
<task>
  <file>packages/annotation/src/store/useCommentStore.ts</file>
  <description>Build Zustand store for comment thread management</description>
  <steps>
    1. Define CommentStore interface with threads array and actions
    2. Implement addThread(action) - creates new thread for annotation
    3. Implement addComment(action) - adds comment to thread
    4. Implement updateThreadStatus(action) - changes thread status
    5. Add devtools and persist middleware for debugging
    6. Integrate with Supabase for persistence (table: comment_threads, comments)
  </steps>
</task>
```

### Task 3: Create MentionsInput component
```xml
<task>
  <file>packages/annotation/src/components/MentionsInput.tsx</file>
  <description>Build textarea with @mention autocomplete using react-mentions</description>
  <steps>
    1. Install react-mentions: `bun add react-mentions`
    2. Create component wrapping MentionsInput from react-mentions
    3. Configure @ trigger with displayTransform and markup="@__id__"
    4. Implement user search from Supabase users table
    5. Render suggestion with avatar and display name
    6. Handle mention validation on submit
  </steps>
</task>
```

### Task 4: Build CommentThread component
```xml
<task>
  <file>packages/annotation/src/components/CommentThread.tsx</file>
  <description>Create threaded comment display component</description>
  <steps>
    1. Create CommentThreadItem for individual comment rendering
    2. Implement recursive rendering for nested replies (depth prop)
    3. Add visual indentation based on depth level (ml-${depth * 4})
    4. Display author avatar, name, timestamp
    5. Highlight @mentions with special styling
    6. Add reply button that opens MentionsInput for that thread
  </steps>
</task>
```

### Task 5: Create CommentInput component
```xml
<task>
  <file>packages/annotation/src/components/CommentInput.tsx</file>
  <description>Build comment input with submit and cancel actions</description>
  <steps>
    1. Create form with MentionsInput for content
    2. Add submit button that calls useCommentStore.addComment
    3. Add cancel button that closes input
    4. Validate content not empty before submit
    5. Show loading state during submission
    6. Clear input after successful submit
  </steps>
</task>
```

### Task 6: Create thread helper utilities
```xml
<task>
  <file>packages/annotation/src/utils/threadHelpers.ts</file>
  <description>Create utility functions for thread operations</description>
  <steps>
    1. Create generateThreadId() - generates unique thread ID
    2. Create getThreadForAnnotation(annotationId) - retrieves thread for annotation
    3. Create getRootComments(thread) - filters comments without parentId
    4. Create buildCommentTree(comments) - builds nested structure for display
    5. Create parseMentions(content) - extracts @mentions from comment text
  </steps>
</task>
```

## Verification
- [ ] Comments display in threaded format with visual hierarchy
- [ ] @mentions autocomplete shows user list with avatars
- [ ] Replies nest under parent comments with indentation
- [ ] Mentioned users are stored in comment.mentions array
- [ ] Comment input supports @trigger for mentions
