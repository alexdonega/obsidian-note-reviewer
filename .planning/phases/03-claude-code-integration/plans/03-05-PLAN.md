---
phase: 03-claude-code-integration
plan: 05
type: execute
wave: 5
depends_on: ["03-01b", "03-02b", "03-03b", "03-04b"]
files_modified:
  - apps/hook/server/index.ts
  - packages/ui/utils/__tests__/claudeExport.test.ts
  - packages/ui/utils/claudeExport.ts
autonomous: false

must_haves:
  truths:
    - "All 5 AnnotationType values have test cases"
    - "export.totalCount equals input annotations.length for mixed array"
    - "Hook server receives and outputs all annotation types"
    - "Endpoint /api/send-annotations accepts and forwards annotations"
  artifacts:
    - path: "apps/hook/server/index.ts"
      provides: "Hook server with /api/send-annotations endpoint"
      exports: ["/api/send-annotations"]
    - path: "packages/ui/utils/__tests__/claudeExport.test.ts"
      provides: "Comprehensive type coverage tests"
      min_lines: 120
    - path: "packages/ui/utils/claudeExport.ts"
      provides: "Complete type mapping with metadata"
      exports: ["exportForClaude"]
  key_links:
    - from: "apps/portal/src/components/PromptEditor.tsx"
      to: "apps/hook/server/index.ts"
      via: "API endpoint"
      pattern: "/api/send-annotations"
    - from: "apps/hook/server/index.ts"
      to: "stdout"
      via: "console.log"
      pattern: "hookSpecificOutput"
---

<objective>
Ensure all annotation types are captured and sent to Claude Code through end-to-end integration.

**Purpose:** Complete CLAU-06 requirement - ALL annotation types (edits, global comments, individual comments, deletions, highlights) are captured and sent.

**Output:** API endpoint integration, comprehensive type coverage tests, and E2E verification.
</objective>

<execution_context>
@C:\Users\Alex\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Alex\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-claude-code-integration/03-CONTEXT.md
@.planning/phases/03-claude-code-integration/03-RESEARCH.md

# Prior work
@.planning/phases/03-claude-code-integration/03-03a-SUMMARY.md
@.planning/phases/03-claude-code-integration/03-04b-SUMMARY.md

# Existing patterns
@apps/hook/server/index.ts
@packages/ui/utils/claudeExport.ts
@packages/ui/types/claude.ts
</context>

<tasks>

<task type="auto">
  <name>Audit annotation type coverage</name>
  <files>packages/ui/utils/claudeExport.ts</files>
  <action>
    Review `packages/ui/utils/claudeExport.ts` transformAnnotation() function:

    1. **Verify all 5 types handled** - Check typeMap has entries for:
       - DELETION
       - INSERTION
       - REPLACEMENT
       - COMMENT
       - GLOBAL_COMMENT

    2. **Check for default/else cases** - Remove any "default" that might drop types

    3. **Verify status preservation** - All types include status field

    4. **Create verification checklist** - Add comment listing all types and their mappings

    If any type missing, add explicit mapping.

    DO NOT rely on default fallback - each type must be explicitly handled.
  </action>
  <verify>All 5 AnnotationType values explicitly mapped in typeMap</verify>
  <done>Type coverage audit confirms no missing annotations</done>
</task>

<task type="auto">
  <name>Add comprehensive type coverage tests</name>
  <files>packages/ui/utils/__tests__/claudeExport.test.ts</files>
  <action>
    Extend `packages/ui/utils/__tests__/claudeExport.test.ts` with:

    1. **Individual test for each type** - 5 separate test cases:
       - DELETION: exports with originalText, type: 'deletion'
       - INSERTION: exports as 'edit' with text and originalText
       - REPLACEMENT: exports as 'edit' with text and originalText
       - COMMENT: exports as 'comment_individual' with comment
       - GLOBAL_COMMENT: exports as 'comment_global' with comment

    2. **Status preservation test** - Each type preserves open/in_progress/resolved

    3. **Mixed array test** - All 5 types together:
       - Verify export.totalCount === 5
       - Verify export.annotations.length === 5
       - Verify each type present in result

    4. **No filtering test** - Verify all statuses included (not just 'open')

    Use test.each() or describe.each() for DRY test code.

    DO NOT skip any AnnotationType - all must have explicit test case.
  </action>
  <verify>Tests run; 5+ test cases for individual types; 1 test for mixed array</verify>
  <done>Test coverage proves all annotation types export correctly</done>
</task>

<task type="auto">
  <name>Verify PromptEditor includes all types</name>
  <files>apps/portal/src/components/AnnotationExport.tsx</files>
  <action>
    Review `apps/portal/src/components/AnnotationExport.tsx`:

    1. **Check display groups** - Verify all 5 ClaudeAnnotationType values have display logic:
       - edit (edições)
       - comment_global (comentários globais)
       - comment_individual (comentários individuais)
       - deletion (exclusões)
       - highlight (marcações - if applicable)

    2. **Verify no filtering** - Ensure no type is excluded from display

    3. **Test visually** - Create one of each annotation type and verify all appear

    If any type missing from display, add section.

    DO NOT filter by status - show all annotations regardless of open/in_progress/resolved.
  </action>
  <verify>AnnotationExport component has display logic for all 5 types</verify>
  <done>Preview shows all annotation types when present</done>
</task>

<task type="auto">
  <name>Add send validation logging</name>
  <files>apps/portal/src/components/PromptEditor.tsx</files>
  <action>
    Add logging/validation to PromptEditor send flow:

    1. **Pre-send validation** - Log to console:
       - Total annotations being sent
       - Count by type (edições, comentários globais, etc.)

    2. **Count assertion** - Verify export.totalCount === annotations.length before sending
       - Log warning if mismatch

    3. **Type breakdown** - Log metadata.types to confirm all types present

    This helps catch filtering bugs during development.

    DO NOT remove logging in production - useful for debugging user issues.
  </action>
  <verify>Send function logs annotation counts by type before API call</verify>
  <done>Validation logging catches potential filtering bugs</done>
</task>

<task type="auto">
  <name>Update hook server endpoint</name>
  <files>apps/hook/server/index.ts</files>
  <action>
    Update `apps/hook/server/index.ts` to add `/api/send-annotations` endpoint:

    1. **Route matcher** - POST /api/send-annotations
    2. **Accept body** - ClaudeAnnotationExport format
    3. **Validate structure** - Check summary, annotations array, totalCount present
    4. **Log for debugging** - Output totalCount and types breakdown to stderr
    5. **Output to stdout** - Use hookSpecificOutput format:
       ```json
       {
         "hookSpecificOutput": {
           "hookEventName": "PostToolUse",
           "result": "ANNOTATIONS_EXPORTED",
           "annotations": [...],
           "summary": "...",
           "totalCount": N
         }
       }
       ```
    6. **Close server** - setTimeout(() => server.stop(), 500) after sending

    NOTE: Use /api/send-annotations (NOT /api/send-to-claude) for consistency.

    DO NOT filter annotations - output all types received.
  </action>
  <verify>Server has POST /api/send-annotations route</verify>
  <done>Hook server accepts and forwards all annotation types</done>
</task>

<task type="auto">
  <name>Add type coverage metric to export</name>
  <files>packages/ui/utils/claudeExport.ts</files>
  <action>
    Add type coverage metric to ClaudeAnnotationExport.metadata:

    1. **Count by type** - Record count of each ClaudeAnnotationType present
    2. **List coverage** - Array of types present (e.g., ['edit', 'comment_global'])
    3. **Include in metadata**:
       ```typescript
       metadata: {
         exportDate: new Date().toISOString(),
         types: {
           edit: 2,
           comment_global: 1,
           comment_individual: 3,
           deletion: 1,
           highlight: 0
         },
         coverage: ['edit', 'comment_global', 'comment_individual', 'deletion']
       }
       ```

    Use in PromptEditor summary to show what's included at a glance.

    DO NOT calculate coverage on every render - only on export.
  </action>
  <verify>exportForClaude() returns metadata with types and coverage fields</verify>
  <done>Type coverage metric provides at-a-glance verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete E2E flow for annotation capture and sending (all types + tests + endpoint + validation)</what-built>
  <how-to-verify>
    End-to-end testing:

    1. Start hook server: `cd apps/hook && bun run dev`
    2. Start portal: `cd apps/portal && bun run dev`
    3. Trigger hook: Create plan file in Obsidian or activate plan mode
    4. Create annotations - one of each type:
       - 1 deletion
       - 1 insertion
       - 1 replacement
       - 1 individual comment
       - 1 global comment
    5. Click "Send to Claude Code"
    6. Verify in browser console:
       - Total count: 5
       - All 5 types listed
    7. Verify hook server stderr shows:
       - Received 5 annotations
       - Types breakdown
    8. Verify hook server stdout outputs JSON with all 5 annotations
    9. Verify server closes after sending

    Expected outcomes:
    - All 5 annotation types present in export
    - totalCount equals 5
    - Hook stdout includes all annotations
    - JSON structure valid
    - Server closes cleanly
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] All 5 AnnotationType values explicitly mapped
- [ ] Unit tests cover each type individually
- [ ] Mixed array test verifies no types dropped
- [ ] AnnotationExport displays all types
- [ ] Send validation logs counts by type
- [ ] Hook server endpoint accepts and outputs all types
- [ ] Type coverage metric in metadata
- [ ] E2E test confirms complete workflow
</verification>

<success_criteria>
1. All annotation types captured and sent to Claude Code (CLAU-06 complete)
2. Test coverage proves no types dropped
3. Manual E2E confirms complete workflow
4. Endpoint naming consistent (/api/send-annotations)
</success_criteria>

<output>
After completion, create `.planning/phases/03-claude-code-integration/03-05-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-05
**Estimated duration:** 25 min
**Complexity:** Low (verification and testing focus)
