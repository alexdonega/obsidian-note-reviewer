---
phase: 01-authentication
plan: 06
type: execute
wave: 4
depends_on: ["01-01", "01-02"]
files_modified:
  - components/auth/LogoutButton.tsx
  - components/auth/UserMenu.tsx
  - components/auth/ProtectedRoute.tsx
  - app/dashboard/page.tsx
  - app/layout.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Logout button shows confirmation dialog before signing out (per locked decision)"
    - "User can sign out from any page and is redirected to /login"
    - "User menu displays with display name and avatar"
    - "Protected routes redirect unauthenticated users to /login"
    - "Dashboard page exists and shows user info"
  artifacts:
    - path: "components/auth/LogoutButton.tsx"
      provides: "Logout button with confirmation dialog"
      contains: "'use client'"
      min_lines: 30
    - path: "components/auth/UserMenu.tsx"
      provides: "User menu with avatar and display name"
      contains: "'use client'"
      min_lines: 50
    - path: "components/auth/ProtectedRoute.tsx"
      provides: "Server-side protected route wrapper"
      contains: "getUser"
      min_lines: 30
    - path: "app/dashboard/page.tsx"
      provides: "Protected dashboard page"
      contains: "user"
      min_lines: 20
  key_links:
    - from: "components/auth/LogoutButton.tsx"
      to: "lib/auth/hooks.ts"
      via: "import useAuth"
      pattern: "useAuth.*signOut"
    - from: "components/auth/UserMenu.tsx"
      to: "components/auth/LogoutButton.tsx"
      via: "import LogoutButton"
      pattern: "LogoutButton"
    - from: "app/dashboard/page.tsx"
      to: "lib/supabase/server.ts"
      via: "import createClient"
      pattern: "from.*supabase/server"
---

<objective>
Create logout functionality with confirmation dialog, user menu component with avatar/display name, and protected route utilities.

Purpose: Complete the authentication flow by providing logout (with confirmation per locked decision), user profile display, and route protection for authenticated pages.

Output: LogoutButton component, UserMenu component, ProtectedRoute utility, dashboard page.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/01-authentication/01-RESEARCH.md
@.planning/phases/01-authentication/01-01-PLAN.md
@.planning/phases/01-authentication/01-02-PLAN.md
@.planning/phases/01-authentication/01-05-PLAN.md

# Locked decisions (from Phase Context):
- Logout REQUIRES confirmation (dialog "Tem certeza?")
- User profile displays with display name and avatar

# Research-based patterns:
- Server Component user checks for protected routes
- Server Action auth checks for protected mutations
- Avatar URL from user metadata

# Claude's discretion (from research):
- Confirmation dialog for logout
- Friendly confirmation message: "Tem certeza que deseja sair?"
</context>

<tasks>

<task type="auto">
  <name>Create LogoutButton with confirmation dialog</name>
  <files>components/auth/LogoutButton.tsx</files>
  <action>
Create components/auth/LogoutButton.tsx:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@/lib/auth/hooks'
import toast from 'react-hot-toast'

interface LogoutButtonProps {
  variant?: 'default' | 'destructive'
  className?: string
}

export function LogoutButton({ variant = 'default', className = '' }: LogoutButtonProps) {
  const [showConfirm, setShowConfirm] = useState(false)
  const [loading, setLoading] = useState(false)
  const { signOut } = useAuth()
  const router = useRouter()

  const handleLogout = async () => {
    setLoading(true)

    try {
      await signOut()
      toast.success('Logout realizado com sucesso!')
      router.push('/auth/login')
    } catch (error: any) {
      toast.error(error.message || 'Erro ao fazer logout.')
    } finally {
      setLoading(false)
    }
  }

  if (showConfirm) {
    return (
      <div className="flex items-center gap-2">
        <span className="text-sm text-muted-foreground">Tem certeza?</span>
        <button
          onClick={handleLogout}
          disabled={loading}
          className="px-3 py-1 text-sm bg-destructive text-destructive-foreground rounded hover:bg-destructive/90 disabled:opacity-50"
        >
          {loading ? 'Saindo...' : 'Sim, sair'}
        </button>
        <button
          onClick={() => setShowConfirm(false)}
          disabled={loading}
          className="px-3 py-1 text-sm border border-input rounded hover:bg-accent disabled:opacity-50"
        >
          Cancelar
        </button>
      </div>
    )
  }

  return (
    <button
      onClick={() => setShowConfirm(true)}
      className={`px-4 py-2 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${
        variant === 'destructive'
          ? 'bg-destructive text-destructive-foreground hover:bg-destructive/90'
          : 'border border-input hover:bg-accent'
      } ${className}`}
    >
      Sair
    </button>
  )
}
```

NOTES:
- Confirmation dialog "Tem certeza?" (per locked decision)
- Two-step process: click logout → confirm → logout
- Toast notification on success/error
- Redirects to /auth/login after logout
- Flexible styling (variant prop)
  </action>
  <verify>test -f components/auth/LogoutButton.tsx && grep -q "Tem certeza" components/auth/LogoutButton.tsx && grep -q "signOut" components/auth/LogoutButton.tsx</verify>
  <done>components/auth/LogoutButton.tsx renders logout button with confirmation dialog</done>
</task>

<task type="auto">
  <name>Create UserMenu component with avatar and display name</name>
  <files>components/auth/UserMenu.tsx</files>
  <action>
Create components/auth/UserMenu.tsx:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@/lib/auth/hooks'
import { getAvatarUrl } from '@/lib/supabase/storage'
import { LogoutButton } from './LogoutButton'

export function UserMenu() {
  const { user } = useAuth()
  const [isOpen, setIsOpen] = useState(false)
  const router = useRouter()

  if (!user) {
    return null
  }

  const displayName = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0] || 'Usuário'
  const avatarUrl = getAvatarUrl(user)
  const email = user.email

  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-accent transition-colors"
      >
        {avatarUrl ? (
          <img
            src={avatarUrl}
            alt={displayName}
            className="w-8 h-8 rounded-full object-cover"
          />
        ) : (
          <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
            <span className="text-sm font-medium text-primary">
              {displayName.charAt(0).toUpperCase()}
            </span>
          </div>
        )}
        <span className="text-sm font-medium hidden sm:inline">{displayName}</span>
      </button>

      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-10"
            onClick={() => setIsOpen(false)}
          />

          {/* Menu */}
          <div className="absolute right-0 mt-2 w-56 bg-card border rounded-md shadow-lg z-20">
            {/* User Info */}
            <div className="px-4 py-3 border-b">
              <p className="text-sm font-medium">{displayName}</p>
              <p className="text-xs text-muted-foreground truncate">{email}</p>
            </div>

            {/* Menu Items */}
            <div className="py-1">
              <button
                onClick={() => {
                  setIsOpen(false)
                  router.push('/dashboard')
                }}
                className="block w-full text-left px-4 py-2 text-sm hover:bg-accent"
              >
                Dashboard
              </button>
              <button
                onClick={() => {
                  setIsOpen(false)
                  router.push('/settings')
                }}
                className="block w-full text-left px-4 py-2 text-sm hover:bg-accent"
              >
                Configurações
              </button>
            </div>

            {/* Logout */}
            <div className="px-4 py-3 border-t">
              <LogoutButton className="w-full" variant="default" />
            </div>
          </div>
        </>
      )}
    </div>
  )
}
```

NOTES:
- Displays avatar (with fallback to initial) and display name
- Dropdown menu with navigation options
- Includes LogoutButton with confirmation
- Closes on backdrop click
- Responsive (hide name on mobile)
  </action>
  <verify>test -f components/auth/UserMenu.tsx && grep -q "LogoutButton" components/auth/UserMenu.tsx && grep -q "getAvatarUrl" components/auth/UserMenu.tsx</verify>
  <done>components/auth/UserMenu.tsx renders dropdown menu with user avatar, display name, and logout button</done>
</task>

<task type="auto">
  <name>Create ProtectedRoute utility component</name>
  <files>components/auth/ProtectedRoute.tsx</files>
  <action>
Create components/auth/ProtectedRoute.tsx:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

interface ProtectedRouteProps {
  children: React.ReactNode
}

export async function ProtectedRoute({ children }: ProtectedRouteProps) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/auth/login')
  }

  return <>{children}</>
}
```

NOTES:
- Server component for route protection
- Checks auth server-side (more secure than client-only)
- Redirects to /auth/login if not authenticated
- Wrap any protected page content with this component
  </action>
  <verify>test -f components/auth/ProtectedRoute.tsx && grep -q "getUser" components/auth/ProtectedRoute.tsx && grep -q "redirect" components/auth/ProtectedRoute.tsx</verify>
  <done>components/auth/ProtectedRoute.tsx exports server component that protects routes</done>
</task>

<task type="auto">
  <name>Create basic dashboard page</name>
  <files>app/dashboard/page.tsx</files>
  <action>
Create app/dashboard/page.tsx:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { ProtectedRoute } from '@/components/auth/ProtectedRoute'

export default async function DashboardPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/auth/login')
  }

  const displayName = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0] || 'Usuário'
  const avatarUrl = user.user_metadata?.avatar_url

  return (
    <ProtectedRoute>
      <div className="min-h-screen bg-background">
        <header className="border-b">
          <div className="container mx-auto px-4 py-4 flex items-center justify-between">
            <h1 className="text-xl font-bold">Obsidian Note Reviewer</h1>
            {/* User menu would go here once we add navigation */}
          </div>
        </header>

        <main className="container mx-auto px-4 py-8">
          <div className="space-y-6">
            {/* Welcome */}
            <div>
              <h2 className="text-3xl font-bold tracking-tight">
                Olá, {displayName}!
              </h2>
              <p className="text-muted-foreground">
                Bem-vindo ao seu dashboard.
              </p>
            </div>

            {/* User Info Card */}
            <div className="bg-card p-6 rounded-lg border">
              <h3 className="text-lg font-semibold mb-4">Seu Perfil</h3>
              <div className="flex items-center gap-4">
                {avatarUrl ? (
                  <img
                    src={avatarUrl}
                    alt={displayName}
                    className="w-16 h-16 rounded-full object-cover"
                  />
                ) : (
                  <div className="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center">
                    <span className="text-2xl font-medium text-primary">
                      {displayName.charAt(0).toUpperCase()}
                    </span>
                  </div>
                )}
                <div>
                  <p className="font-medium">{displayName}</p>
                  <p className="text-sm text-muted-foreground">{user.email}</p>
                </div>
              </div>
            </div>

            {/* Placeholder for future content */}
            <div className="bg-card p-6 rounded-lg border">
              <h3 className="text-lg font-semibold mb-2"> coming Soon</h3>
              <p className="text-muted-foreground">
                Mais recursos serão adicionados em breve.
              </p>
            </div>
          </div>
        </main>
      </div>
    </ProtectedRoute>
  )
}
```

NOTES:
- Protected page (redirects if not authenticated)
- Shows user display name and avatar
- Basic layout with header and main content
- Placeholder for future dashboard features
  </action>
  <verify>test -f app/dashboard/page.tsx && grep -q "ProtectedRoute" app/dashboard/page.tsx</verify>
  <done>app/dashboard/page.tsx renders protected dashboard page with user info</done>
</task>

<task type="auto">
  <name>Add navigation header with user menu to root layout</name>
  <files>app/layout.tsx</files>
  <action>
Update app/layout.tsx to include navigation header with UserMenu.

Read the existing file first, then add the UserMenu to a header section. The layout should look like:

```typescript
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'
import { AuthProvider } from '@/lib/auth/context'
import { UserMenu } from '@/components/auth/UserMenu'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'Obsidian Note Reviewer',
  description: 'Visual markdown review tool with Claude Code integration',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <AuthProvider>
          {/* Navigation Header */}
          <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
            <div className="container flex h-14 items-center justify-between">
              <div className="flex items-center gap-4">
                <a href="/" className="font-bold text-lg">
                  Obsidian Note Reviewer
                </a>
              </div>
              <nav className="flex items-center gap-4">
                <UserMenu />
              </nav>
            </div>
          </header>

          {/* Page Content */}
          {children}
        </AuthProvider>
      </body>
    </html>
  )
}
```

NOTES:
- Adds sticky header with navigation
- UserMenu appears on right side of header
- Only shows UserMenu when user is authenticated (handled inside UserMenu component)
  </action>
  <verify>grep -q "UserMenu" app/layout.tsx && grep -q "header" app/layout.tsx</verify>
  <done>app/layout.tsx includes navigation header with UserMenu</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Logout functionality with confirmation, user menu, protected routes, and dashboard page</what-built>
  <how-to-verify>
1. Run: npm run dev
2. Visit http://localhost:3000/dashboard (should redirect to /auth/login)
3. Login with test account
4. Verify dashboard shows user's display name and avatar
5. Test user menu:
   - Click on user avatar/name in header
   - Verify dropdown appears with user info
   - Verify "Dashboard" and "Configurações" links
6. Test logout:
   - Click "Sair" button
   - Verify confirmation dialog appears: "Tem certeza?"
   - Click "Cancelar" - menu should close, stay logged in
   - Click user menu again, click "Sair", click "Sim, sair"
   - Verify toast "Logout realizado com sucesso!"
   - Verify redirect to /auth/login
7. Test route protection:
   - Try accessing /dashboard while logged out
   - Verify redirect to /auth/login
8. Test session persistence:
   - Login, refresh page
   - Verify still logged in (middleware working)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks and approval:

1. Run: npm run build to verify no TypeScript errors
2. Check components: ls components/auth/LogoutButton.tsx components/auth/UserMenu.tsx components/auth/ProtectedRoute.tsx
3. Verify dashboard: test -f app/dashboard/page.tsx
4. Check layout integration: grep -q "UserMenu" app/layout.tsx
</verification>

<success_criteria>
- Logout button shows confirmation dialog before signing out
- User redirected to /auth/login after logout
- User menu displays avatar and display name
- Protected routes redirect unauthenticated users
- Dashboard shows user information
- Session persists across page refresh
- Header with user menu appears on all pages
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication/01-06-SUMMARY.md` with:
- Logout flow implementation notes
- User menu details
- Route protection approach
- Dashboard page structure
</output>
