---
phase: 01-authentication
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - app/auth/callback/route.ts
  - app/auth/forgot-password/page.tsx
  - app/auth/reset-password/page.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "OAuth callback handles code exchange and redirects appropriately"
    - "User after OAuth signup is redirected to /welcome"
    - "User after OAuth login is redirected to /dashboard"
    - "Forgot password page sends reset email via Supabase"
    - "Reset password page allows updating password with valid token"
  artifacts:
    - path: "app/auth/callback/route.ts"
      provides: "OAuth callback handler"
      exports: ["GET"]
      contains: "exchangeCodeForSession"
      min_lines: 20
    - path: "app/auth/forgot-password/page.tsx"
      provides: "Password reset request page"
      contains: "resetPasswordForEmail"
      min_lines: 40
    - path: "app/auth/reset-password/page.tsx"
      provides: "Password reset form page"
      contains: "updateUser"
      min_lines: 50
  key_links:
    - from: "app/auth/callback/route.ts"
      to: "lib/supabase/server.ts"
      via: "import createClient"
      pattern: "from.*supabase/server"
    - from: "app/auth/callback/route.ts"
      to: "app/auth/login/page.tsx"
      via: "OAuth redirect configuration"
      pattern: "redirectTo.*callback"
---

<objective>
Implement OAuth callback handler and password reset flow (forgot password + reset password pages).

Purpose: Complete the authentication flow by handling OAuth redirects and providing password reset functionality via Supabase.

Output: OAuth callback route, forgot password page, reset password page.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/01-authentication/01-RESEARCH.md
@.planning/phases/01-authentication/01-01-PLAN.md
@.planning/phases/01-authentication/01-02-PLAN.md

# Locked decisions (from Phase Context):
- Signup → Welcome page
- First login → Dashboard (no repeated onboarding)

# Research-based patterns:
- Pattern 3: OAuth Callback Handler with PKCE flow
- Password Reset: resetPasswordForEmail() + updateUser()
- Dynamic origin for redirect URLs (avoid Pitfall 2)

# Claude's discretion (from research):
- Supabase built-in password reset flow with custom UI
- Friendly error messages with toast notifications
</context>

<tasks>

<task type="auto">
  <name>Create OAuth callback route handler</name>
  <files>app/auth/callback/route.ts</files>
  <action>
Create app/auth/callback/route.ts:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/welcome'
  const redirectTo = searchParams.get('redirectTo') ?? next

  if (code) {
    const supabase = await createClient()
    await supabase.auth.exchangeCodeForSession(code)
  }

  // Redirect to welcome page (for new users) or dashboard (for returning users)
  // The actual logic to distinguish new vs returning users could be added here
  // For now, we use the redirectTo parameter
  redirect(origin + redirectTo)
}
```

NOTES:
- Uses PKCE flow (exchangeCodeForSession) per research
- Dynamic origin for redirect (avoids Pitfall 2)
- Defaults to /welcome for new users (per locked decision: Signup → Welcome)
- Supports `next` and `redirectTo` params for flexibility

The OAuth flow:
1. User clicks "Entrar com Google/GitHub" button
2. Supabase redirects to provider with PKCE code challenge
3. Provider redirects back to /auth/callback with code
4. This route exchanges code for session
5. User redirected to appropriate page
  </action>
  <verify>test -f app/auth/callback/route.ts && grep -q "exchangeCodeForSession" app/auth/callback/route.ts && grep -q "redirect" app/auth/callback/route.ts</verify>
  <done>app/auth/callback/route.ts handles OAuth code exchange and redirects appropriately</done>
</task>

<task type="auto">
  <name>Create forgot password page</name>
  <files>app/auth/forgot-password/page.tsx</files>
  <action>
Create app/auth/forgot-password/page.tsx:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { createClient } from '@/lib/supabase/client'
import toast from 'react-hot-toast'

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('')
  const [loading, setLoading] = useState(false)
  const [sent, setSent] = useState(false)
  const router = useRouter()
  const supabase = createClient()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/auth/reset-password`,
      })

      if (error) throw error

      setSent(true)
      toast.success('Email de recuperação enviado! Verifique sua caixa de entrada.')
    } catch (error: any) {
      toast.error(error.message || 'Erro ao enviar email. Tente novamente.')
    } finally {
      setLoading(false)
    }
  }

  if (sent) {
    return (
      <div className="min-h-screen flex items-center justify-center p-8">
        <div className="w-full max-w-md space-y-8">
          <div className="space-y-2">
            <h2 className="text-3xl font-bold tracking-tight">Email enviado</h2>
            <p className="text-muted-foreground">
              Enviamos um email para <strong>{email}</strong> com instruções para redefinir sua senha.
            </p>
          </div>

          <div className="space-y-4">
            <button
              onClick={() => router.push('/auth/login')}
              className="w-full px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
            >
              Voltar ao login
            </button>
            <button
              onClick={() => {
                setSent(false)
                setEmail('')
              }}
              className="w-full px-4 py-2 border border-input rounded-md hover:bg-accent transition-colors"
            >
              Tentar outro email
            </button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center p-8">
      <div className="w-full max-w-md space-y-8">
        <div className="space-y-2">
          <h2 className="text-3xl font-bold tracking-tight">Esqueceu sua senha?</h2>
          <p className="text-muted-foreground">
            Digite seu email e enviaremos instruções para redefinir sua senha.
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label htmlFor="email" className="block text-sm font-medium mb-1">
              Email
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring"
              placeholder="seu@email.com"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? 'Enviando...' : 'Enviar email de recuperação'}
          </button>
        </form>

        <p className="text-center text-sm text-muted-foreground">
          Lembrou sua senha?{' '}
          <Link href="/auth/login" className="text-primary hover:underline">
            Faça login
          </Link>
        </p>
      </div>
    </div>
  )
}
```

NOTES:
- Uses Supabase's resetPasswordForEmail() per research
- Dynamic origin for redirect URL (avoids Pitfall 2)
- Shows success state after sending email
- Back to login link available
  </action>
  <verify>test -f app/auth/forgot-password/page.tsx && grep -q "resetPasswordForEmail" app/auth/forgot-password/page.tsx</verify>
  <done>app/auth/forgot-password/page.tsx renders password reset request form</done>
</task>

<task type="auto">
  <name>Create reset password page</name>
  <files>app/auth/reset-password/page.tsx</files>
  <action>
Create app/auth/reset-password/page.tsx:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import toast from 'react-hot-toast'

export default function ResetPasswordPage() {
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  const supabase = createClient()

  useEffect(() => {
    // Check if user has a valid reset token
    supabase.auth.getUser().then(({ data, error }) => {
      if (error || !data.user) {
        toast.error('Link inválido ou expirado. Solicite uma nova recuperação de senha.')
        router.push('/auth/forgot-password')
      }
    })
  }, [router, supabase])

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (password !== confirmPassword) {
      toast.error('As senhas não coincidem')
      return
    }

    if (password.length < 6) {
      toast.error('A senha deve ter pelo menos 6 caracteres')
      return
    }

    setLoading(true)

    try {
      const { error } = await supabase.auth.updateUser({
        password,
      })

      if (error) throw error

      toast.success('Senha redefinida com sucesso!')
      router.push('/auth/login')
    } catch (error: any) {
      toast.error(error.message || 'Erro ao redefinir senha. Tente novamente.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center p-8">
      <div className="w-full max-w-md space-y-8">
        <div className="space-y-2">
          <h2 className="text-3xl font-bold tracking-tight">Redefinir senha</h2>
          <p className="text-muted-foreground">
            Digite sua nova senha abaixo.
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label htmlFor="password" className="block text-sm font-medium mb-1">
              Nova senha
            </label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              minLength={6}
              className="w-full px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring"
              placeholder="Mínimo 6 caracteres"
            />
          </div>

          <div>
            <label htmlFor="confirmPassword" className="block text-sm font-medium mb-1">
              Confirmar nova senha
            </label>
            <input
              id="confirmPassword"
              type="password"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              required
              minLength={6}
              className="w-full px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring"
              placeholder="Digite a senha novamente"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? 'Redefinindo...' : 'Redefinir senha'}
          </button>
        </form>

        <p className="text-center text-sm text-muted-foreground">
          <button
            onClick={() => router.push('/auth/login')}
            className="text-primary hover:underline"
          >
            Voltar ao login
          </button>
        </p>
      </div>
    </div>
  )
}
```

NOTES:
- Uses Supabase's updateUser() per research
- Validates reset token on mount (redirects if invalid)
- Password confirmation and length validation
- Redirects to login after success
  </action>
  <verify>test -f app/auth/reset-password/page.tsx && grep -q "updateUser" app/auth/reset-password/page.tsx</verify>
  <done>app/auth/reset-password/page.tsx renders password reset form with validation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>OAuth callback handler, forgot password page, and reset password page</what-built>
  <how-to-verify>
1. Test OAuth flow:
   - Run: npm run dev
   - Visit http://localhost:3000/auth/login
   - Click "Entrar com Google" (or GitHub)
   - Complete OAuth flow in provider popup
   - Verify redirect to /welcome (or configured redirect)

2. Test password reset flow:
   - Visit http://localhost:3000/auth/forgot-password
   - Enter email and submit
   - Check for success message and email sent confirmation
   - Go to email inbox and click reset link
   - On reset page, enter new password
   - Verify redirect to /auth/login after success
   - Try logging in with new password

3. Test error cases:
   - Invalid/expired reset token (should redirect to forgot-password)
   - Mismatched passwords (should show error)
   - Short password (should show error)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks and approval:

1. Run: npm run build to verify no TypeScript errors
2. Check callback route: test -f app/auth/callback/route.ts
3. Verify password reset flow: ls app/auth/forgot-password/page.tsx app/auth/reset-password/page.tsx
</verification>

<success_criteria>
- OAuth callback successfully exchanges code for session
- User redirected appropriately after OAuth (signup→/welcome, login→/dashboard)
- Forgot password email sent via Supabase
- Reset password page validates token and updates password
- Error cases handled with toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication/01-04-SUMMARY.md` with:
- OAuth flow implementation notes
- Password reset flow implementation notes
- Redirect behavior confirmation
</output>
